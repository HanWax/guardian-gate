{
  "project": "RoleCall",
  "branchName": "compound/configure-supabase-auth",
  "description": "Configure Supabase Auth with magic link (passwordless email) login for the RoleCall admin dashboard with role-based access control",
  "tasks": [
    {
      "id": "T-001",
      "title": "Create Supabase client configuration file",
      "description": "Create lib/supabase.ts with Supabase client initialization, auth configuration, and Hebrew error message translations",
      "acceptanceCriteria": [
        "File lib/supabase.ts exists",
        "File imports from @supabase/supabase-js",
        "File exports createClient() function",
        "File reads SUPABASE_URL from environment",
        "File reads SUPABASE_ANON_KEY from environment",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-002",
      "title": "Add Hebrew error message translations to Supabase client",
      "description": "Define Hebrew translations for common auth errors (invalid email, OTP expired, network errors, etc.)",
      "acceptanceCriteria": [
        "File lib/supabase.ts contains authErrorMessages object",
        "Object contains keys for: invalid_credentials, otp_expired, user_not_found, network_error",
        "Each key has Hebrew text value (RTL-safe)",
        "Export getHebrewErrorMessage(errorCode) function",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-003",
      "title": "Configure auth state change listener in Supabase client",
      "description": "Set up onAuthStateChange listener to monitor and persist authentication state",
      "acceptanceCriteria": [
        "File lib/supabase.ts contains auth state subscription",
        "Auth state listener triggers on session changes",
        "Export function to get current auth state",
        "Export function to subscribe to auth changes",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-004",
      "title": "Verify environment variables are configured",
      "description": "Check that SUPABASE_URL and SUPABASE_ANON_KEY are available in .env",
      "acceptanceCriteria": [
        ".env file exists",
        ".env contains SUPABASE_URL=https://[project].supabase.co",
        ".env contains SUPABASE_ANON_KEY (non-empty value)",
        "Run `npm run typecheck` - exits with code 0 (no env variable errors)"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-005",
      "title": "Create login page with email input form",
      "description": "Create /login route with email input field and form for requesting magic link",
      "acceptanceCriteria": [
        "File app/routes/login.tsx exists (or login page in app structure)",
        "Page contains email input field with id or data-testid",
        "Page contains submit button",
        "Email input has type='email'",
        "Form has onSubmit handler",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-006",
      "title": "Add email validation to login form",
      "description": "Implement client-side email format validation before magic link submission",
      "acceptanceCriteria": [
        "File app/routes/login.tsx contains email validation logic",
        "Invalid email format shows error message",
        "Error message is in Hebrew",
        "Submit button disabled when email is invalid",
        "Valid email enables submit button",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-007",
      "title": "Implement magic link submission handler",
      "description": "Add handler that calls supabase.auth.signInWithOtp() when form is submitted",
      "acceptanceCriteria": [
        "File app/routes/login.tsx has signInWithOtp handler",
        "Handler calls supabase.auth.signInWithOtp with email address",
        "Handler sets loading state during submission",
        "Handler catches and displays errors",
        "Handler clears form on success",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-008",
      "title": "Add success message display after magic link sent",
      "description": "Show Hebrew success message after magic link email is sent",
      "acceptanceCriteria": [
        "File app/routes/login.tsx contains success message state",
        "Success message displays in Hebrew after OTP sent",
        "Success message includes instruction to check email",
        "Success message visible for at least 5 seconds or until dismissed",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-009",
      "title": "Add Hebrew error message display to login form",
      "description": "Display Hebrew error messages when magic link submission fails",
      "acceptanceCriteria": [
        "File app/routes/login.tsx displays errors from signInWithOtp failure",
        "Errors are translated to Hebrew using getHebrewErrorMessage()",
        "Error messages are displayed prominently",
        "Error state can be dismissed",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-010",
      "title": "Create auth callback route handler",
      "description": "Create /auth/callback route to handle magic link verification",
      "acceptanceCriteria": [
        "File app/routes/auth/callback.tsx exists (or callback route in app structure)",
        "Route accepts hash parameters from magic link URL",
        "Route extracts auth code from URL",
        "Route logs extracted code to notes for verification",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-011",
      "title": "Implement OTP code exchange in callback route",
      "description": "Exchange OTP code from magic link for valid session",
      "acceptanceCriteria": [
        "File app/routes/auth/callback.tsx calls verifyOtp() or equivalent",
        "Handler exchanges code for session token",
        "Handler detects verification success or failure",
        "On success: session is stored",
        "On failure: error is logged to notes",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-012",
      "title": "Implement redirect to dashboard after successful auth",
      "description": "Redirect authenticated user to dashboard after callback completes",
      "acceptanceCriteria": [
        "File app/routes/auth/callback.tsx contains redirect logic",
        "On successful auth: redirect to / (dashboard)",
        "Redirect happens server-side (not client-side redirect loop)",
        "Session is available to middleware before redirect",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-013",
      "title": "Display Hebrew error message on auth callback failure",
      "description": "Show Hebrew error when magic link is invalid, expired, or verification fails",
      "acceptanceCriteria": [
        "File app/routes/auth/callback.tsx displays error on verification failure",
        "Error message is in Hebrew",
        "Error includes instruction (retry or request new link)",
        "User can navigate back to login from error page",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-014",
      "title": "Create auth middleware to check session",
      "description": "Add middleware that checks for valid session before allowing access to protected routes",
      "acceptanceCriteria": [
        "File middleware.ts or app middleware exists",
        "Middleware reads Supabase session from cookies or auth state",
        "Middleware defines public routes (allow without auth): /login, /auth/callback",
        "Middleware defines protected routes (require auth): / (dashboard) and any others",
        "Middleware exports middleware function",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-015",
      "title": "Implement unauthenticated user redirect in middleware",
      "description": "Redirect unauthenticated users accessing protected routes to /login",
      "acceptanceCriteria": [
        "File middleware.ts checks for valid session in protected routes",
        "If no valid session: redirect to /login",
        "If valid session: continue to requested route",
        "Redirect preserves original URL for post-login redirect (optional but recommended)",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-016",
      "title": "Configure session persistence across page refreshes",
      "description": "Ensure Supabase session cookie is properly configured for SSR and persists across reloads",
      "acceptanceCriteria": [
        "File lib/supabase.ts or middleware has cookie storage config",
        "Supabase client configured with storage strategy (cookie or localStorage)",
        "Session persists when reloading page",
        "Session available to server-side code (middleware, server functions)",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-017",
      "title": "Define TypeScript role types",
      "description": "Create TypeScript types for role-based access control",
      "acceptanceCriteria": [
        "File lib/types.ts or similar exists",
        "Export type Role = 'admin' | 'manager' | 'teacher'",
        "Role type used consistently throughout auth code",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-018",
      "title": "Create React Context for authentication state",
      "description": "Create AuthContext provider to expose user, role, loading, and signOut throughout app",
      "acceptanceCriteria": [
        "File lib/auth-context.tsx or similar exists",
        "Export AuthProvider component (React Context provider)",
        "Export useAuth() hook to access context",
        "Context provides: user (Supabase User object), role (Role type), loading (boolean), signOut (function)",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 18,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-019",
      "title": "Implement role reading from user metadata",
      "description": "Extract user role from Supabase user.user_metadata.role",
      "acceptanceCriteria": [
        "File lib/auth-context.tsx reads user.user_metadata?.role",
        "Default role if not set: 'teacher' (or log to notes if should be different)",
        "Role type-checked against Role type definition",
        "useAuth hook returns current role",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 19,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-020",
      "title": "Implement signOut function in auth context",
      "description": "Add signOut() function to AuthContext that signs out user and redirects",
      "acceptanceCriteria": [
        "File lib/auth-context.tsx contains signOut implementation",
        "signOut calls supabase.auth.signOut()",
        "signOut clears local state",
        "signOut redirects to /login after completion",
        "useAuth hook returns signOut function",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 20,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-021",
      "title": "Wrap app with AuthProvider",
      "description": "Apply AuthProvider context wrapper at app root level",
      "acceptanceCriteria": [
        "Root layout or app component imports AuthProvider",
        "Root layout/component wraps children with <AuthProvider>",
        "All pages and components can use useAuth() hook",
        "Run `npm run typecheck` - exits with code 0"
      ],
      "priority": 21,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-022",
      "title": "Test login flow end-to-end",
      "description": "Verify complete login flow from page load to dashboard access",
      "acceptanceCriteria": [
        "agent-browser: open http://localhost:3000/login - page loads",
        "agent-browser: snapshot -i - find email input field ref",
        "agent-browser: fill @email 'test-auth@example.com' - value entered",
        "agent-browser: screenshot tmp/login-filled.png - capture filled form",
        "agent-browser: console - no errors logged",
        "Form submit button is clickable"
      ],
      "priority": 22,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-023",
      "title": "Test unauthenticated redirect to login",
      "description": "Verify that accessing dashboard without auth redirects to login",
      "acceptanceCriteria": [
        "agent-browser: open http://localhost:3000/ - redirects to /login",
        "agent-browser: wait --load networkidle - page settles",
        "agent-browser: screenshot tmp/redirect-to-login.png - capture redirect",
        "agent-browser: console - no errors logged",
        "Current URL is /login after redirect"
      ],
      "priority": 23,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-024",
      "title": "Test session persistence across refresh",
      "description": "Verify session persists after page reload (requires valid logged-in session)",
      "acceptanceCriteria": [
        "Prerequisite: User is logged in with valid session",
        "agent-browser: open http://localhost:3000/ - dashboard loads",
        "agent-browser: wait --load networkidle - page settles",
        "agent-browser: screenshot tmp/dashboard-before-refresh.png - capture dashboard",
        "agent-browser: refresh page - page reloads",
        "agent-browser: wait --load networkidle - page settles",
        "agent-browser: screenshot tmp/dashboard-after-refresh.png - dashboard still visible (not redirected to login)",
        "Session persists without re-authentication"
      ],
      "priority": 24,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-025",
      "title": "Test email input validation on login form",
      "description": "Verify email validation rejects invalid formats",
      "acceptanceCriteria": [
        "agent-browser: open http://localhost:3000/login - page loads",
        "agent-browser: fill @email 'invalid-email' - value entered",
        "agent-browser: screenshot tmp/invalid-email.png - capture validation state",
        "Invalid email format shows error message in Hebrew (or UI prevents submit)",
        "agent-browser: fill @email 'valid@example.com' - value entered",
        "Valid email format clears error (or enables submit button)"
      ],
      "priority": 25,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-026",
      "title": "Test auth context hook in component",
      "description": "Verify useAuth() hook returns user, role, loading, and signOut",
      "acceptanceCriteria": [
        "Create test component that uses useAuth()",
        "Component renders user name or email",
        "Component renders user role",
        "Component renders loading state appropriately",
        "Component renders signOut button",
        "Run `npm run typecheck` - exits with code 0",
        "Run `npm test` - tests pass"
      ],
      "priority": 26,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-027",
      "title": "Verify all Hebrew messages display correctly",
      "description": "Check that all auth UI messages are in Hebrew with proper RTL formatting",
      "acceptanceCriteria": [
        "agent-browser: open http://localhost:3000/login - page loads",
        "agent-browser: screenshot tmp/login-hebrew.png - capture UI text",
        "All visible text is in Hebrew (or appropriate for locale)",
        "RTL text alignment is correct (text flows right-to-left)",
        "Error messages (when triggered) display in Hebrew",
        "Success messages display in Hebrew"
      ],
      "priority": 27,
      "passes": false,
      "notes": ""
    },
    {
      "id": "T-028",
      "title": "Run full type check and tests",
      "description": "Final verification that all code passes type checking and tests",
      "acceptanceCriteria": [
        "Run `npm run typecheck` - exits with code 0",
        "Run `npm test` - exits with code 0 (or document failing tests in notes)",
        "Run `npm run build` - exits with code 0",
        "No console warnings or errors during build"
      ],
      "priority": 28,
      "passes": false,
      "notes": ""
    }
  ]
}
